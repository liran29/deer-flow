# MCP Server集成方案讨论记录

## 讨论背景
在将MindsDB MCP Server集成到deep-research流程中时，我们遇到了以下问题：
1. MCP Server目前仅在database_investigation_node中使用，其他Agent无法利用本地数据库
2. 如何让本地数据成为用户报告的事实依据
3. 是否应该强行整合本地数据查询到现有的Web搜索为主的流程中

## 讨论过程

### 初始方案探讨

#### 方案一：扩展现有节点的MCP能力
- 为researcher和coder节点添加MCP工具
- 让LLM智能选择使用数据库查询还是网络搜索
- **问题**：可能导致节点职责不清晰

#### 方案二：新增专门的数据查询节点
- 创建database_researcher_node专门处理数据库查询
- **问题**：
  - Planner不知道何时生成database_query类型的步骤
  - Router难以智能判断何时使用专门节点
  - 增加系统复杂度

#### 方案三：创建统一的MCP工具接口
- 封装MCP工具供所有节点使用
- **结论**：过度工程化，当前阶段不必要

#### 方案四：改进Planner的数据库感知能力
- 让Planner理解数据库能力并生成相应步骤
- **问题**：需要大量训练和改造

### 核心问题识别

1. **信息传递链断裂**
   - Database Investigator只提供元数据（表结构、字段信息）
   - Planner基于元数据制定计划，但元数据≠实际数据内容
   - Researcher执行时可能忽略本地数据，偏向Web搜索

2. **职责定位冲突**
   - 强行整合可能破坏原有系统的优雅性
   - Web搜索和数据库查询有不同的优势和适用场景

3. **用户需求矛盾**
   - 用户希望获得准确的数据和信息，能追溯来源
   - 但不同数据源可能产生冲突的结果

## 最终选定方案：双轨并行 + 智能融合

### 核心理念
保持两个系统独立，在更高层面协调，而不是强行整合。

### 系统架构
```
用户查询 → 智能分发器(Query Router)
            ├── 数据分析轨道 (Local Data Track)
            │    └── 专注本地数据查询和分析
            └── 研究调查轨道 (Deep Research Track)  
                 └── 保持现有Web搜索流程
                      ↓
                智能报告生成器(Smart Report Fusion)
                 (融合两轨结果，处理冲突)
```

### 三种执行模式

1. **纯数据查询模式** (Data-Driven)
   - 适用场景："统计上个月沃尔玛的订单数量"
   - 只走数据分析管道

2. **纯研究模式** (Research-Driven)
   - 适用场景："分析零售行业的未来趋势"
   - 只走Deep Research管道

3. **混合模式** (Hybrid)
   - 适用场景："分析沃尔玛的订单数据趋势"
   - 两个管道并行执行，结果智能融合

### 关键优势

1. **保持系统独立性**
   - Deep Research流程完全不变
   - 数据分析有专门的优化路径
   - 两个系统可以独立演进

2. **清晰的数据溯源**
   - 每个发现都标注来源、查询语句、可信度
   - 用户可以追踪每个结论的依据

3. **智能冲突处理**
   - 当本地数据与Web信息冲突时，生成对比分析
   - 根据查询意图和数据可信度做出合理判断

4. **灵活的执行策略**
   - 根据查询类型智能选择执行模式
   - 避免不必要的计算和API调用

## 实施计划

### Phase 1: 构建独立的数据分析管道
- 创建DataAnalysisPipeline类
- 实现数据查询、分析、可视化功能
- 不改动现有Deep Research流程

### Phase 2: 实现智能路由器
- 创建query_router_node
- 基于查询意图判断执行模式
- 支持三种执行模式的分发

### Phase 3: 开发融合报告生成器
- 创建SmartReportFusion类
- 实现冲突检测和解决机制
- 生成结构化的融合报告

## 总结
此方案避免了强行整合的复杂性，保持了系统的模块化和可维护性，同时满足了用户对准确数据和信息溯源的需求。