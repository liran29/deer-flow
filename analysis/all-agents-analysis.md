# Deer-Flow å®Œæ•´å·¥ä½œæµå’ŒTokenåˆ†æ

## ä¸»è¦ç ”ç©¶å·¥ä½œæµèŠ‚ç‚¹

### 1. **coordinator** (åè°ƒå‘˜)
- **ä½ç½®**: `src/graph/nodes.py:coordinator_node()`
- **LLMç±»å‹**: basic
- **å·¥å…·**: handoff_to_plannerå·¥å…·
- **ä½œç”¨**: 
  - è§£æç”¨æˆ·è¾“å…¥
  - æå–research_topicå’Œlocale
  - å†³å®šæ˜¯å¦è¿›å…¥ç ”ç©¶æµç¨‹
- **Tokenå½±å“**: è½»å¾® (~200 tokens)
- **è°ƒç”¨æ¬¡æ•°**: 1æ¬¡

### 2. **background_investigator** (èƒŒæ™¯è°ƒæŸ¥å‘˜)
- **ä½ç½®**: `src/graph/nodes.py:background_investigation_node()`
- **LLMç±»å‹**: æ— LLMè°ƒç”¨ï¼ˆä½¿ç”¨æœç´¢APIï¼‰
- **å·¥å…·**: Tavilyæœç´¢æˆ–Webæœç´¢
- **ä½œç”¨**:
  - è·å–ç ”ç©¶ä¸»é¢˜çš„èƒŒæ™¯ä¿¡æ¯
  - ä¸ºplanneræä¾›åˆå§‹ä¸Šä¸‹æ–‡
- **Tokenå½±å“**: è¾“å‡ºåˆ°state (~3000-8000 tokens)
- **è°ƒç”¨æ¬¡æ•°**: 1æ¬¡

### 3. **planner** (è§„åˆ’å‘˜)  
- **ä½ç½®**: `src/graph/nodes.py:planner_node()`
- **LLMç±»å‹**: basic
- **å·¥å…·**: æ— å·¥å…·ï¼Œçº¯LLMæ¨ç†
- **ä½œç”¨**:
  - **ç¬¬ä¸€æ¬¡è°ƒç”¨**: åŸºäºèƒŒæ™¯è°ƒæŸ¥ç”Ÿæˆç ”ç©¶è®¡åˆ’
  - **ç¬¬äºŒæ¬¡è°ƒç”¨**: è¯„ä¼°ç ”ç©¶å®Œæˆåº¦ï¼Œå†³å®šæ˜¯å¦ç”ŸæˆæŠ¥å‘Š
- **è¾“å…¥æ•°æ®**:
  - ç¬¬ä¸€æ¬¡: research_topic + background_investigation_results
  - ç¬¬äºŒæ¬¡: åŒä¸Š + æ‰€æœ‰completed steps (é€šè¿‡stateä¼ é€’)
- **Tokenå½±å“**: é‡å¤§ (~4000-6000 tokens)
- **è°ƒç”¨æ¬¡æ•°**: é€šå¸¸2æ¬¡

### 4. **human_feedback** (äººå·¥åé¦ˆ)
- **ä½ç½®**: `src/graph/nodes.py:human_feedback_node()`
- **LLMç±»å‹**: æ— LLMè°ƒç”¨
- **ä½œç”¨**: ç­‰å¾…ç”¨æˆ·ç¡®è®¤ç ”ç©¶è®¡åˆ’
- **Tokenå½±å“**: æ— 
- **è°ƒç”¨æ¬¡æ•°**: 1æ¬¡

### 5. **research_team** (ç ”ç©¶å›¢é˜Ÿåè°ƒ)
- **ä½ç½®**: `src/graph/nodes.py:research_team_node()`
- **LLMç±»å‹**: æ— LLMè°ƒç”¨ï¼ˆè·¯ç”±èŠ‚ç‚¹ï¼‰
- **ä½œç”¨**: é€šè¿‡æ¡ä»¶åˆ¤æ–­è·¯ç”±åˆ°å…·ä½“æ‰§è¡ŒèŠ‚ç‚¹
- **Tokenå½±å“**: æ— 
- **è°ƒç”¨æ¬¡æ•°**: æ¯ä¸ªæ­¥éª¤1æ¬¡

### 6. **researcher** (ç ”ç©¶å‘˜)
- **ä½ç½®**: `src/graph/nodes.py:researcher_node()`  
- **LLMç±»å‹**: basic (ReActæ¡†æ¶)
- **å·¥å…·**: 
  - Web search tool
  - Crawl tool  
  - Local retriever tool (å¦‚æœæœ‰resources)
  - MCP tools (åŠ¨æ€åŠ è½½)
- **ä½œç”¨**:
  - æ‰§è¡ŒRESEARCHç±»å‹çš„æ­¥éª¤
  - æ”¶é›†ä¿¡æ¯å’Œè¯æ®
  - ç”Ÿæˆç ”ç©¶å‘ç°
- **Tokenç´¯ç§¯æœºåˆ¶**: 
  - Step 1: åŸºç¡€prompt + å½“å‰ä»»åŠ¡ (~2000 tokens)
  - Step 2: åŸºç¡€prompt + Step1ç»“æœ + å½“å‰ä»»åŠ¡ (~5000 tokens)
  - Step 3: åŸºç¡€prompt + Step1&2ç»“æœ + å½“å‰ä»»åŠ¡ (~8000 tokens)
  - Step N: æŒ‡æ•°çº§å¢é•¿
- **è°ƒç”¨æ¬¡æ•°**: æ¯ä¸ªRESEARCHæ­¥éª¤1æ¬¡

### 7. **coder** (ç¼–ç å‘˜)
- **ä½ç½®**: `src/graph/nodes.py:coder_node()`
- **LLMç±»å‹**: basic (ReActæ¡†æ¶)
- **å·¥å…·**:
  - Python REPL tool
  - MCP tools (åŠ¨æ€åŠ è½½)
- **ä½œç”¨**:
  - æ‰§è¡ŒPROCESSINGç±»å‹çš„æ­¥éª¤
  - ä»£ç åˆ†æå’Œè®¡ç®—
  - ç”Ÿæˆé‡åŒ–ç»“æœ
- **Tokenå½±å“**: ä¸researcherç›¸åŒçš„ç´¯ç§¯æ¨¡å¼
- **è°ƒç”¨æ¬¡æ•°**: æ¯ä¸ªPROCESSINGæ­¥éª¤1æ¬¡

### 8. **reporter** (æŠ¥å‘Šå‘˜)
- **ä½ç½®**: `src/graph/nodes.py:reporter_node()`
- **LLMç±»å‹**: basic
- **å·¥å…·**: æ— å·¥å…·ï¼Œçº¯LLMæ¨ç†
- **ä½œç”¨**:
  - ç»¼åˆæ‰€æœ‰ç ”ç©¶å‘ç°
  - ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š
  - åº”ç”¨æŠ¥å‘Šæ ·å¼æ ¼å¼åŒ–
- **è¾“å…¥æ•°æ®**: current_plan + æ‰€æœ‰observations
- **Tokenå½±å“**: æœ€å¤§ (~15000+ tokens)
- **è°ƒç”¨æ¬¡æ•°**: 1æ¬¡

## ä¸“ä¸šåŒ–Agent (éç ”ç©¶å·¥ä½œæµ)

### 9. **podcast_script_writer** (æ’­å®¢è„šæœ¬å†™æ‰‹)
- **ä½ç½®**: `src/podcast/graph/script_writer_node.py`
- **LLMç±»å‹**: basic
- **å·¥å…·**: æ— 
- **ä½œç”¨**: å°†ç ”ç©¶æŠ¥å‘Šè½¬æ¢ä¸ºæ’­å®¢è„šæœ¬
- **ä½¿ç”¨æ¨¡å¼**: ç›´æ¥LLMè°ƒç”¨ï¼Œéagentæ¡†æ¶

### 10. **ppt_composer** (PPTç»„æˆå‘˜)
- **ä½ç½®**: `src/ppt/graph/ppt_composer_node.py`  
- **LLMç±»å‹**: basic
- **å·¥å…·**: æ— 
- **ä½œç”¨**: å°†ç ”ç©¶æŠ¥å‘Šè½¬æ¢ä¸ºPPTå†…å®¹
- **ä½¿ç”¨æ¨¡å¼**: ç›´æ¥LLMè°ƒç”¨ï¼Œéagentæ¡†æ¶

### 11. **prompt_enhancer** (æç¤ºå¢å¼ºå™¨)
- **ä½ç½®**: `src/prompt_enhancer/graph/enhancer_node.py`
- **LLMç±»å‹**: basic
- **å·¥å…·**: æ— 
- **ä½œç”¨**: å¢å¼ºå’Œä¼˜åŒ–ç”¨æˆ·æç¤ºè¯
- **ä½¿ç”¨æ¨¡å¼**: ç›´æ¥LLMè°ƒç”¨ï¼Œéagentæ¡†æ¶

### 12. **prose_writer** (æ•£æ–‡å†™æ‰‹)
- **ä½ç½®**: `src/prose/graph/prose_*_node.py` (å¤šä¸ªå˜ä½“)
- **LLMç±»å‹**: basic
- **å·¥å…·**: æ— 
- **ä½œç”¨**: æ–‡æœ¬å¤„ç†å’Œä¼˜åŒ–
- **å˜ä½“**:
  - prose_continue: ç»§ç»­å†™ä½œ
  - prose_fix: ä¿®å¤æ–‡æœ¬
  - prose_improve: æ”¹è¿›æ–‡æœ¬  
  - prose_longer: å»¶é•¿æ–‡æœ¬
  - prose_shorter: ç¼©çŸ­æ–‡æœ¬
  - prose_zap: æ–‡æœ¬å¤„ç†

## å®Œæ•´æ•°æ®æµåˆ†æ

### å·¥ä½œæµè°ƒç”¨é¡ºåº
```
ç”¨æˆ·è¾“å…¥
    â†“
coordinator (æå–research_topic, locale)
    â†“
background_investigator (ç”Ÿæˆbackground_investigation_results)
    â†“
planner [ç¬¬ä¸€æ¬¡] (åŸºäºèƒŒæ™¯è°ƒæŸ¥ + research_topic)
    â†“ [has_enough_context=false]
human_feedback (è®¡åˆ’ç¡®è®¤)
    â†“
research_team (è·¯ç”±åˆ†å‘) â†’ researcher/coder (å¾ªç¯æ‰§è¡Œæ‰€æœ‰æ­¥éª¤)
    â†“ [æ‰€æœ‰æ­¥éª¤å®Œæˆ]
planner [ç¬¬äºŒæ¬¡] (åŸºäºèƒŒæ™¯è°ƒæŸ¥ + æ‰€æœ‰ç ”ç©¶ç»“æœ)
    â†“ [has_enough_context=true]
reporter (åŸºäºcurrent_plan + observations)
    â†“
END
```

### Stateæ•°æ®é‡å¤åˆ†æ

**é‡å¤å­˜å‚¨çš„å†…å®¹**:
- `observations[]` = [ç ”ç©¶ç»“æœ1, ç ”ç©¶ç»“æœ2, ç ”ç©¶ç»“æœ3]
- `current_plan.steps[i].execution_res` = åŒæ ·çš„ç ”ç©¶ç»“æœ

**LLMè°ƒç”¨ä¸­çš„æ•°æ®ä½¿ç”¨**:
- **Researcher**: åªä½¿ç”¨ `step.execution_res` (completed_steps_info)
- **Planner**: é€šè¿‡æ¨¡æ¿æ³¨å…¥stateï¼Œä½†ä¸ç›´æ¥ä½¿ç”¨é‡å¤å­—æ®µ
- **Reporter**: åªä½¿ç”¨ `observations`

**ç»“è®º**: è™½ç„¶stateä¸­æœ‰é‡å¤å­˜å‚¨ï¼Œä½†æ²¡æœ‰åœ¨åŒä¸€æ¬¡LLMè°ƒç”¨ä¸­é‡å¤ä¼ é€’

### Tokenç´¯ç§¯æœºåˆ¶è¯¦è§£

**Researcheræ­¥éª¤ç´¯ç§¯**:
```
Step 1æ‰§è¡Œ: åªæœ‰å½“å‰ä»»åŠ¡
Step 2æ‰§è¡Œ: Step1ç»“æœ + å½“å‰ä»»åŠ¡
Step 3æ‰§è¡Œ: Step1ç»“æœ + Step2ç»“æœ + å½“å‰ä»»åŠ¡  
Step Næ‰§è¡Œ: æ‰€æœ‰å‰é¢æ­¥éª¤ç»“æœ + å½“å‰ä»»åŠ¡
```

**å…³é”®å‘ç°**: æ¯å¢åŠ ä¸€ä¸ªstepï¼Œè¾“å…¥tokenéƒ½ä¼šç´¯ç§¯å¢é•¿ï¼Œè¿™æ˜¯tokenæŒ‡æ•°çº§å¢é•¿çš„æ ¹æœ¬åŸå› 

## Agentè°ƒç”¨æ¨¡å¼åˆ†æ

### 1. **ReAct Agentæ¡†æ¶** (ä¸»è¦ç ”ç©¶æµç¨‹)
```python
# ä½¿ç”¨create_agentåˆ›å»ºçš„çœŸæ­£agent
agent = create_agent(agent_type, agent_type, tools, agent_type)
result = await agent.ainvoke(input=agent_input, config={"recursion_limit": recursion_limit})
```

**ä½¿ç”¨æ­¤æ¨¡å¼çš„èŠ‚ç‚¹**:
- coordinator
- planner  
- researcher
- coder
- reporter

**ç‰¹ç‚¹**:
- æ”¯æŒå·¥å…·è°ƒç”¨
- æ”¯æŒå¤šè½®æ¨ç†
- åŒ…å«pre_model_hook tokenç®¡ç†
- ç´¯ç§¯å¼ä¸Šä¸‹æ–‡ä¼ é€’

### 2. **ç›´æ¥LLMè°ƒç”¨** (ä¸“ä¸šåŒ–åŠŸèƒ½)
```python
# ç›´æ¥ä½¿ç”¨LLMï¼Œä¸é€šè¿‡agentæ¡†æ¶
model = get_llm_by_type(AGENT_LLM_MAP["agent_name"])
result = model.invoke([SystemMessage(...), HumanMessage(...)])
```

**ä½¿ç”¨æ­¤æ¨¡å¼çš„èŠ‚ç‚¹**:
- podcast_script_writer
- ppt_composer
- prompt_enhancer
- prose_writer (æ‰€æœ‰å˜ä½“)

**ç‰¹ç‚¹**:
- å•æ¬¡è°ƒç”¨ï¼Œæ— å·¥å…·
- ç®€å•çš„è¾“å…¥è¾“å‡º
- ä¸å‚ä¸ç´¯ç§¯ä¸Šä¸‹æ–‡
- Tokenæ¶ˆè€—ç›¸å¯¹å›ºå®š

## Tokenç´¯ç§¯é—®é¢˜æ ¹æºåˆ†æ

### **ç´¯ç§¯æ€§èŠ‚ç‚¹** (Tokençˆ†ç‚¸æºå¤´)
1. **researcher**: æ¯ä¸ªstepç´¯ç§¯å‰é¢æ‰€æœ‰stepçš„ç»“æœ
   - æ ¸å¿ƒé—®é¢˜: `completed_steps_info` æ„å»ºé€»è¾‘
   - å½±å“: æŒ‡æ•°çº§tokenå¢é•¿

2. **coder**: ä¸researcherç›¸åŒçš„ç´¯ç§¯æ¨¡å¼  
   - åŒæ ·çš„ç´¯ç§¯æœºåˆ¶
   - åŒæ ·çš„tokené£é™©

3. **reporter**: æ¥æ”¶æ‰€æœ‰ç´¯ç§¯çš„observations
   - æœ€ç»ˆçš„tokençˆ†ç‚¸ç‚¹
   - åŒ…å«æ‰€æœ‰ç ”ç©¶æ­¥éª¤çš„å®Œæ•´ç»“æœ

### **éç´¯ç§¯æ€§èŠ‚ç‚¹** (ç›¸å¯¹å®‰å…¨)
1. **coordinator**: åªå¤„ç†åˆå§‹è¾“å…¥
2. **background_investigator**: å•æ¬¡æœç´¢è°ƒç”¨
3. **planner**: è™½ç„¶åŒ…å«èƒŒæ™¯ç»“æœï¼Œä½†è°ƒç”¨æ¬¡æ•°å›ºå®š
4. **ä¸“ä¸šåŒ–èŠ‚ç‚¹**: ç‹¬ç«‹è°ƒç”¨ï¼Œä¸å‚ä¸ä¸»å·¥ä½œæµ

### **Plannerçš„ç‰¹æ®Šæƒ…å†µ**
- **ç¬¬ä¸€æ¬¡è°ƒç”¨**: åŸºäºèƒŒæ™¯è°ƒæŸ¥ï¼Œtokené‡å¯æ§
- **ç¬¬äºŒæ¬¡è°ƒç”¨**: åŒ…å«æ‰€æœ‰ç ”ç©¶ç»“æœï¼Œä½†é€šè¿‡stateä¼ é€’ï¼Œä¸é‡å¤è®¡ç®—
- **investigationç»“æœ**: ä¸¤æ¬¡è°ƒç”¨éƒ½åŒ…å«ï¼ŒæŒä¹…å­˜å‚¨åœ¨stateä¸­

## è§£å†³Tokené—®é¢˜çš„ä¼˜åŒ–ç­–ç•¥

### **é«˜ä¼˜å…ˆçº§** (å¿…é¡»è§£å†³)
1. **researcher/coderç´¯ç§¯ä¼˜åŒ–**:
   - é™åˆ¶completed_steps_infoçš„é•¿åº¦
   - ä½¿ç”¨æ‘˜è¦è€Œéå®Œæ•´ç»“æœ
   - å®æ–½æ»‘åŠ¨çª—å£æœºåˆ¶

2. **reporterè¾“å…¥ä¼˜åŒ–**:
   - å‹ç¼©observationså†…å®¹
   - æ™ºèƒ½ç­›é€‰ç›¸å…³ä¿¡æ¯

### **ä¸­ç­‰ä¼˜å…ˆçº§** (å·²éƒ¨åˆ†è§£å†³)
1. **background_investigationå‹ç¼©**: å·²å®æ–½LLMæ‘˜è¦æ–¹æ¡ˆ
2. **æœç´¢ç»“æœè¿‡æ»¤**: å·²å®æ–½å†…å®¹éªŒè¯æœºåˆ¶

### **ä½ä¼˜å…ˆçº§** (å½±å“è¾ƒå°)
1. **coordinator**: å·²ç»æ¯”è¾ƒè½»é‡
2. **ä¸“ä¸šåŒ–èŠ‚ç‚¹**: ä¸å‚ä¸ä¸»è¦ç´¯ç§¯é—®é¢˜

## å…³é”®å‘ç°å’Œç»“è®º

### **æ•°æ®æµç‰¹ç‚¹**
1. **ä¸»è¦å·¥ä½œæµèŠ‚ç‚¹**: 8ä¸ª (coordinator â†’ background_investigator â†’ planner â†’ human_feedback â†’ research_team â†’ researcher/coder â†’ planner â†’ reporter)
2. **ä¸“ä¸šåŒ–åŠŸèƒ½èŠ‚ç‚¹**: 4ä¸ª (ç‹¬ç«‹çš„æ–‡æ¡£å¤„ç†åŠŸèƒ½)
3. **Tokenç´¯ç§¯æœºåˆ¶**: researcher/coderçš„completed_steps_infoæ˜¯æ ¹æœ¬åŸå› 
4. **æ•°æ®é‡å¤**: stateä¸­æœ‰é‡å¤å­˜å‚¨ï¼Œä½†LLMè°ƒç”¨ä¸­æ— é‡å¤ä¼ é€’

### **ä¼˜åŒ–æˆæœ**
1. âœ… **Background investigationæ™ºèƒ½å‹ç¼©**: å·²å®æ–½LLMæ‘˜è¦
2. âœ… **æœç´¢ç»“æœè¿‡æ»¤**: å·²å®æ–½å†…å®¹éªŒè¯
3. âœ… **Templateæ¸²æŸ“ä¿®å¤**: å·²è§£å†³ç©ºå˜é‡é—®é¢˜
4. ğŸ”„ **Researcherç´¯ç§¯ä¼˜åŒ–**: å¾…è¿›ä¸€æ­¥å®æ–½

### **ä¸‹ä¸€æ­¥é‡ç‚¹**
- **æ ¸å¿ƒé—®é¢˜**: researcher/coderçš„completed_steps_infoç´¯ç§¯æœºåˆ¶éœ€è¦æ ¹æœ¬æ€§ä¼˜åŒ–
- **è§£å†³æ–¹æ¡ˆ**: å®æ–½æ™ºèƒ½æ‘˜è¦æˆ–æ»‘åŠ¨çª—å£ï¼Œé¿å…æ— é™ç´¯ç§¯
- **ç›®æ ‡**: å°†tokenå¢é•¿ä»æŒ‡æ•°çº§é™ä½åˆ°çº¿æ€§æˆ–å¸¸é‡çº§