# Deep Research优化策略记录

## 问题背景

### 初始问题
- **表面问题**: Researcher执行时token超限（123,074 tokens vs 65,536 limit）
- **深层问题**: 需要在解决技术问题的同时，确保Deep Research的质量不受影响

### 问题根源分析
1. **ReAct Agent的自主多次工具调用**：复杂step导致Agent多次搜索
2. **工具返回数据量过大**：`include_raw_content=True`导致每次搜索返回大量HTML内容
3. **累积效应**：多次搜索 × 大量数据 = Token爆炸

### 核心洞察
- 不能仅仅解决技术问题，必须考虑对研究质量的影响
- ReAct Agent需要保持探索自由度
- 优化需要分层进行，不能一刀切

## 优化层次框架

### 1. 工具层优化（最底层）- 技术导向
**目标**: 解决token超限，不影响信息获取质量

**方案B: 新工具组合**
```python
# 原始工具
web_search_tool:
  - include_raw_content: true  # 问题所在
  - 每次返回8个结果 × 完整HTML

# 新工具组合  
search_overview:
  - include_raw_content: false  # 轻量级概览
  - 返回标题、摘要、URL、相关性提示

selective_crawl_tool:
  - 选择性爬取特定URL
  - max_content_length: 5000 chars

batch_selective_crawl_tool:
  - 批量爬取2-3个最相关URL  
  - max_content_length: 3000 chars per URL
```

**合理性评估**:
- ✅ **技术合理**: 显著减少token使用
- ✅ **不破坏研究质量**: 仍能获取相同信息，方式更高效
- ✅ **符合ReAct模式**: Agent保持自主决策能力

### 2. Agent行为引导层（中层）- 方法导向
**目标**: 引导Agent更高效地使用工具，提升研究质量

**提示词优化策略**:
```markdown
# 可以做的引导
1. 新工具使用最佳实践指引
2. 强调分析和综合的重要性
3. 建议批量处理复杂查询
4. 提供结构化思考框架

# 不应该做的限制
- ❌ 限制搜索次数
- ❌ 过度约束探索路径
- ❌ 简化研究要求
```

**合理性评估**:
- ✅ **保持研究深度**: 引导而非限制
- ⚠️ **需要谨慎**: 过度引导可能影响探索能力
- ✅ **提升效率**: 减少重复和低效调用

### 3. Step设计优化层（高层）- 结构导向
**目标**: 在保持研究全面性的前提下，优化研究结构

**可以考虑的优化**:
```markdown
# 优化step描述质量
原：调查蝴蝶主题装饰的产品信息
优化：调查蝴蝶主题装饰，分析其作为新热门类别的市场表现和消费者接受度

# 增强分析要求
- 不仅收集信息，还要分析趋势和原因
- 注意不同类别间的关联性
- 考虑时间维度和市场背景
```

**不应该做的**:
- ❌ 简化step复杂度（会降低研究质量）
- ❌ 减少step数量（会影响全面性）
- ❌ 过度拆分step（会失去整体性）

### 4. 系统架构层（最高层）- 架构导向
**当前阶段**: 暂时不动
**原因**: 现有架构基本合理，问题主要在执行层面

## 实施计划

### Phase 1: 工具层优化（立即执行）
**目标**: 解决token超限问题

**实施内容**:
1. 部署新工具组合（search_overview + selective_crawl）
2. 在nodes_enhanced.py中配置工具
3. 创建基础的researcher_enhanced.md（仅工具使用指引）

**验证标准**:
- Token使用量控制在限制范围内
- 信息获取质量不下降
- Agent能正常使用新工具

### Phase 2: 行为引导优化（观察效果后）
**目标**: 提升研究效率和质量

**实施内容**:
1. 根据Phase 1的表现调整提示词
2. 增加结构化思考和分析指引
3. 优化工具使用策略

**验证标准**:
- 研究报告质量提升
- Agent行为更加高效
- 减少重复和无效搜索

### Phase 3: 结构化优化（长期）
**目标**: 系统性提升Deep Research能力

**实施内容**:
1. 基于多次运行结果，优化step设计
2. 增强分析和综合要求
3. 考虑引入专门的分析型指引

**验证标准**:
- 产出真正的深度洞察
- 研究报告具有分析价值
- 用户满意度提升

## 关键原则

### 1. 质量优先原则
- 任何优化都不应降低最终报告的深度和全面性
- 技术优化服务于研究质量

### 2. 渐进改进原则  
- 分层优化，逐步验证
- 避免激进改动带来的意外后果

### 3. 尊重Agent特性原则
- ReAct Agent需要探索自由度
- 引导而非限制Agent行为

### 4. 可验证性原则
- 每个优化都要能测试效果
- 建立明确的验证标准

## 风险评估

### Phase 1 风险（低）
- **技术风险**: 新工具可能有bug
- **缓解**: 充分测试，保留回退方案

### Phase 2 风险（中）
- **行为风险**: 过度引导可能限制Agent创造性
- **缓解**: 渐进调整，保持灵活性

### Phase 3 风险（中-高）
- **结构风险**: 改变研究结构可能影响整体质量
- **缓解**: 小规模试验，充分验证后推广

## 成功指标

### 技术指标
- Token使用量：< 65,536 tokens
- 响应时间：< 5分钟/step
- 错误率：< 5%

### 质量指标
- 信息覆盖率：≥ 90%（相比原始方案）
- 分析深度：定性评估提升
- 用户满意度：≥ 4.0/5.0

### 效率指标
- 平均搜索次数/step：< 3次
- 重复信息率：< 20%
- 研究完成时间：目标减少30%

## 后续跟踪

### 监控机制
1. **实时监控**: Token使用、工具调用次数
2. **质量评估**: 定期人工评估报告质量
3. **用户反馈**: 收集使用者满意度

### 迭代机制
1. **周期性回顾**: 每月评估优化效果
2. **问题响应**: 发现问题及时调整
3. **持续改进**: 基于数据不断优化

## 总结

这个优化策略的核心是：
- **分层递进**: 从技术问题到方法问题，逐层优化
- **质量导向**: 确保Deep Research的价值不受损
- **实证驱动**: 基于实际效果调整策略

通过这样的系统性优化，既解决了当前的token超限问题，又为未来的研究质量提升奠定了基础。